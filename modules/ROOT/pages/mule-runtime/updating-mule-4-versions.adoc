= Upgrading Mule Runtime (Versions 4.x to 4.n)
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: mule, runtime, release notes, migration, installation, downtime, uptime, best practices

This document describes considerations and best practices when changing the 4.x versions of Mule Runtime on your servers. This covers the use cases of deploying to Mule standalone instances, and to on-premises Mule instances through xref:runtime-manager::index.adoc[Runtime Manager].

[IMPORTANT]
====
For guidance with migrations from Mule 3.x to Mule 4, see xref:4.1@mule-runtime::index-migration.adoc[Mule 4 for Mule 3 Users].
====

== Mule Application Runtime Version

Mule runtime engines use semantic versioning, therefore note that Mule applications:

* Are most likely not compatible between major runtime version releases (e.g. *z*.0.0)
* Are potentially compatible between minor runtime version releases (e.g: 4.*y*.0), but MuleSoft recommends executing a regression test cycle to validate this.
* Are assured to be fully compatible for patch releases of the Mule runtime engine(e.g: 4.1.*x*)

=== Prerequisites

Read the xref:mule-runtime/mule-esb.adoc[release notes] for the Mule runtime engine version you wish to upgrade to (which we will call the target version, from here on), to know if you must make any necessary changes to your applications to ensure compatibility.

=== Recommendations

If there are no relevant changes between the Mule version in which the application is developed and the target Mule version to which you're migrating, then you don't need to modify your application. Mule supports having applications that are built with older Mule versions deployed to them.

=== Steps to Change Version

If you do decide to change your Mule application's runtime version, you must:

. xref:studio::studio-update-sites#mule-runtimes-for-anypoint-studio-update-site[Download the newest Mule runtime engine] on Anypoint Studio so that you can handle that version in the IDE.
. For every application that you update:
.. xref:studio::import-export-packages#importing-projects-to-studio[Import the application] to Anypoint Studio as a Mule project.
.. During the import process remember to change the Mule version by selecting it from the *Server Runtime* dropdown menu.
+
image::mule-runtime/updating-mule-versions-415.png[]

.. Make any other changes to your Mule project that are necessary depending on the version gap you are transitioning.
.. xref:studio::import-export-packages#exporting-projects-from-studio[Export your project] as a Mule Deployable Archive (`.jar` file).
.. Edit the `pom.xml` file to change the `muleVersion` property value, so that it matches the target version.

Once the Mule Deployable Archives (`.jar` files) are in versions that are compatible with the target Mule version and you have applied any other necessary changes to ensure compatibility, you can move on to installing the corresponding Mule runtime engine on your servers.


== Mule Standalone Runtime Engine Version

=== Recommendations

To ensure that you have lower downtime and an easier backup route, we recommend that you initially install your new Mule runtime engine on a separate server from where you have your current Mule runtime engine installed.


. Download the new Mule version from the Customer Portal and install it (preferably on a different server or virtual machine).
. If any of your applications use shared custom libraries, make sure you copy those .jar files to the `<MULE_HOME>/lib/user` directory of the new version.
+
[NOTE]
====
If any of your previous applications rely on a full or a partial custom patch in order to work properly (these would be found in the folder `<MULE_HOME>/lib/patches`), please verify that the fix is included in this target release by reviewing the corresponding xref:mule-runtime/mule-esb.adoc[release notes] page.

Otherwise, please contact MuleSoft Support by creating a new support case, to request a new patch compatible with the target version. Patch files are version specific and MUST NOT be used in a different runtime version.
====
+
. Download a new copy of your license from the Customer Portal and install it on the target version, by following the instructions described at xref:4.2@mule-runtime::installing-an-enterprise-license.adoc[Installing an Entrerprise License].
. If you have set any custom configurations to your runtime instance – for example: if you defined a different maximum heap size in the `wrapper.conf` file –  you might want to replicate these settings manually.
. xref:4.2@mule-runtime::starting-and-stopping-mule-esb.adoc[Run your new Mule Server] to verify your installation is working as expected.
. Depending on the circumstances and your current infrastructure, you might want to consider shutting down your previous Mule Server at this point. Please evaluate the impact of this action before proceeding.
. If you have previously set any environment variables, such as `MULE_HOME` or `PATH`, make sure that they are now pointing to the new Runtime's installation path.
. Deploy your applications to your new Mule Server.

== Mule Runtime Engine Version on CloudHub

To change the version of the Mule runtime engine that runs a Mule application deployed to CloudHub, you need to use the xref:runtime-manager::deploying-to-cloudhub.adoc#runtime-tab[runtime version drop-down box] in the application settings deployment configuration page.

If you need to change the Mule runtime engine version used to develop your application, refer to the  <<Mule Application Runtime Version>> section.

[[mulerunvers]]
== Mule Runtime Version on Runtime Manager

[NOTE]
To migrate following these steps, you must have the xref:runtime-manager::runtime-manager-agent.adoc[Runtime Management Agent] installed.

[TIP]
To ensure that you'll have less downtime and an easier backup route, we recommend that you initially install your new Mule Runtime on a separate server from where you have your current Mule Runtime installed. That way you can set everything up and only then decouple the old server and initiate the new one.

To migrate your Mule servers on-premises that are being managed through Runtime Manager, you must perform these steps on each:

. Go through steps 1 through to 5 of the previous section, <<Mule Standalone Runtime Version>>
. Copy the following three files from the path `<MULE_HOME>/conf` from your old Mule installation into the same on the new installation:
* `mule-agent.yml`
* `mule-agent.jks`
* `truststore.jks` and/or `anypoint-truststore.jks`
. Copy the mule-agent-plugin folder from the path `<MULE_HOME>/plugins` from your old Mule installation into the same on the new installation.
. Open a terminal window and navigate to the `<MULE_HOME>/bin` of your new Mule installation. Once there, run the following command:
+
----
amc_setup -U
----
+
Through executing this command, you're installing the latest version of the Runtime Manager Agent on your Mule runtime, which is assured to be compatible with your target runtime version. The files you copied from your old installation hold all of the configuration information that registers the Mule instance on Runtime Manager, so no further steps should be needed.
+
Even when you're installing your new Mule runtime version on another server or VM, the copied configuration files should suffice to smoothly transition the Mule instance's identity on the Runtime Manager.
+
If your origin server had apps that were deployed to it through the Runtime Manager, there's no need to manually copy these, as they automatically upload to your new server when instructed to deploy them through Runtime Manager.
+
[CAUTION]
====
Applications must be running and showing as `Started` in Runtime Manager. This process does not migrate stopped Applications.
====

. At this point the Mule server is already updated to the target version. Updating the Mule applications that are deployed to it is optional. If wish to do so to take full advantage of the features of the target runtime, then you must also:
.. Follow the steps in <<Application Runtime Version>> to update your application.
.. Find the application on the *Applications* tab on Runtime Manager and click *Choose File* to xref:runtime-manager::managing-deployed-applications.adoc#updating-your-application[upload] the new Mule Deployable Archive (.jar file).

== Upgrading a Runtime Manager Cluster     

Zero downtime cannot be guaranteed when migrating clusters to another version. At some point during the migration the cluster is in a mixed state, with coexisting nodes running two different versions. This might lead to incompatible communication protocols between Hazelcast instances. +
When such errors occur, every node in the cluster must be shut down to proceed with the migration.

== See Also

Please feel free to contact MuleSoft Support if you have any question that is not covered by this article.
